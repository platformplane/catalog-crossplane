apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: rabbitmqservers.catalog.cluster.local
  annotations:
    catalog.cluster.local/displayName: "RabbitMQ Server"
    catalog.cluster.local/description: "Unmanaged RabbitMQServer instance running within the cluster."
    catalog.cluster.local/contact: ""
    catalog.cluster.local/url: "https://www.rabbitmq.com"
    catalog.cluster.local/tags: "mq,unmanaged,helm"
spec:
  compositeTypeRef:
    apiVersion: catalog.cluster.local/v1
    kind: RabbitMQServerComposite

  writeConnectionSecretsToNamespace: crossplane-system

  resources:
    - name: helm-release
      base:
        apiVersion: helm.crossplane.io/v1beta1
        kind: Release
        spec:
          providerConfigRef:
            name: provider-helm
          forProvider:
            chart:
              name: rabbitmq
              repository: oci://registry-1.docker.io/bitnamicharts
              version: 12.15.0
            namespace: tbd
            values:
              commonLabels:
                catalog.cluster.local/kind: tbd
                catalog.cluster.local/name: tbd
              podLabels:
                catalog.cluster.local/kind: tbd
                catalog.cluster.local/name: tbd
              fullnameOverride: tbd
              auth:
                username: platform
              persistence:
                size: 8Gi
                persistentVolumeClaimRetentionPolicy:
                  enabled: true
                  whenDeleted: Delete
              metrics:
                enabled: true
                serviceMonitor:
                  enabled: true                

          connectionDetails:
            - apiVersion: v1
              kind: Secret
              name: # patch taken from spec.claimRef.name
              namespace: # patch taken from composite spec.claimRef.namespace
              fieldPath: data.rabbitmq-password
              toConnectionSecretKey: password

            - apiVersion: v1
              kind: Service
              name: # patch taken from spec.claimRef.name
              namespace: # patch taken from composite spec.claimRef.namespace
              fieldPath: spec.ports[0].port
              toConnectionSecretKey: port

          writeConnectionSecretToRef:
            namespace: tbd

      connectionDetails:
        - name: username
          type: FromValue
          value: platform

        - name: password
          type: FromConnectionSecretKey
          fromConnectionSecretKey: password

        - name: port
          type: FromConnectionSecretKey
          fromConnectionSecretKey: port

        - name: host
          type: FromFieldPath
          fromFieldPath: "metadata.annotations['host']"

      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: "spec.size"
          toFieldPath: "spec.forProvider.values.persistence.size"        
          
        - type: FromCompositeFieldPath
          fromFieldPath: "spec.claimRef.name"
          toFieldPath: "spec.forProvider.values.fullnameOverride"

        - type: FromCompositeFieldPath
          fromFieldPath: "spec.claimRef.name"
          toFieldPath: "spec.forProvider.values.commonLabels['catalog.cluster.local/name']"

        - type: FromCompositeFieldPath
          fromFieldPath: "spec.claimRef.kind"
          toFieldPath: "spec.forProvider.values.commonLabels['catalog.cluster.local/kind']"
        
        - type: FromCompositeFieldPath
          fromFieldPath: "spec.claimRef.name"
          toFieldPath: "spec.forProvider.values.podLabels['catalog.cluster.local/name']"

        - type: FromCompositeFieldPath
          fromFieldPath: "spec.claimRef.kind"
          toFieldPath: "spec.forProvider.values.podLabels['catalog.cluster.local/kind']"          

        - type: FromCompositeFieldPath
          fromFieldPath: "spec.claimRef.namespace"
          toFieldPath: "spec.forProvider.namespace"

        - type: FromCompositeFieldPath
          fromFieldPath: "spec.claimRef.name"
          toFieldPath: "spec.connectionDetails[0].name"

        - type: FromCompositeFieldPath
          fromFieldPath: "spec.claimRef.namespace"
          toFieldPath: "spec.connectionDetails[0].namespace"

        - type: FromCompositeFieldPath
          fromFieldPath: "spec.claimRef.name"
          toFieldPath: "spec.connectionDetails[1].name"
        
        - type: FromCompositeFieldPath
          fromFieldPath: "spec.claimRef.namespace"
          toFieldPath: "spec.connectionDetails[1].namespace"

        - type: FromCompositeFieldPath
          fromFieldPath: "spec.claimRef.namespace"
          toFieldPath: "spec.writeConnectionSecretToRef.namespace"

        - type: FromCompositeFieldPath
          fromFieldPath: "spec.resourceRefs[0].name"
          toFieldPath: "spec.writeConnectionSecretToRef.name"
          transforms:
            - type: string
              string:
                type: Format
                fmt: "%s-connection"
                
        - type: CombineToComposite
          combine:
            variables:
              - fromFieldPath: spec.forProvider.values.fullnameOverride
              - fromFieldPath: spec.forProvider.namespace
            strategy: string
            string:
              fmt: "%s.%s"
          toFieldPath: status.credentials.host
          
        - type: FromCompositeFieldPath
          fromFieldPath: "status.credentials.host"
          toFieldPath: "metadata.annotations['host']"
