apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: mongodbs.catalog.cluster.local
  annotations:
    catalog.cluster.local/title: "MongoDB"
    catalog.cluster.local/description: "MongoDB is a popular NoSQL database that provides a flexible and scalable solution for storing and retrieving data. It is designed to handle large amounts of unstructured data, making it suitable for a wide range of applications."
    catalog.cluster.local/icon: "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE1LjkuMDg3bC44NTQgMS42MDRjLjE5Mi4yOTYuNC41NTguNjQ1LjgwMi43MTUuNzE1IDEuMzk0IDEuNDY0IDIuMDA0IDIuMjY2IDEuNDQ3IDEuOSAyLjQyMyA0LjAxIDMuMTIgNi4yOTIuNDE4IDEuMzk0LjY0NSAyLjgyNC42NjIgNC4yNy4wNyA0LjMyMy0xLjQxMiA4LjAzNS00LjQgMTEuMTItLjQ4OC40ODgtMS4wMS45NC0xLjU3IDEuMzQyLS4yOTYgMC0uNDM2LS4yMjctLjU1OC0uNDM2LS4yMjctLjM4My0uMzY2LS44Mi0uNDM2LTEuMjU1LS4xMDUtLjUyMy0uMTc0LTEuMDQ2LS4xNC0xLjU4NnYtLjI0NEMxNi4wNTcgMjQuMjEgMTUuNzk2LjIxIDE1LjkuMDg3eiIgZmlsbD0iIzU5OTYzNiIvPgo8cGF0aCBkPSJNMTUuOS4wMzRjLS4wMzUtLjA3LS4wNy0uMDE3LS4xMDUuMDE3LjAxNy4zNS0uMTA1LjY2Mi0uMjk2Ljk2LS4yMS4yOTYtLjQ4OC41MjMtLjc2Ny43NjctMS41NSAxLjM0Mi0yLjc3IDIuOTYzLTMuNzQ3IDQuNzc2LTEuMyAyLjQ0LTEuOTcgNS4wNTUtMi4xNiA3LjgwOC0uMDg3Ljk5My4zMTQgNC40OTcuNjI3IDUuNTA4Ljg1NCAyLjY4NCAyLjM4OCA0LjkzMyA0LjM3NSA2Ljg4NS40ODguNDcgMS4wMS45MDYgMS41NSAxLjMyNS4xNTcgMCAuMTc0LS4xNC4yMS0uMjQ0YTQuNzggNC43OCAwIDAgMCAuMTU3LS42OGwuMzUtMi42MTRMMTUuOS4wMzR6IiBmaWxsPSIjNmNhYzQ4Ii8+CjxwYXRoIGQ9Ik0xNi43NTQgMjguODQ1Yy4wMzUtLjQuMjI3LS43MzIuNDM2LTEuMDYzLS4yMS0uMDg3LS4zNjYtLjI2LS40ODgtLjQ1My0uMTA1LS4xNzQtLjE5Mi0uMzgzLS4yNi0uNTc1LS4yNDQtLjczMi0uMjk2LTEuNS0uMzY2LTIuMjQ4di0uNDUzYy0uMDg3LjA3LS4xMDUuNjYyLS4xMDUuNzVhMTcuMzcgMTcuMzcgMCAwIDEtLjMxNCAyLjM1M2MtLjA1Mi4zMTQtLjA4Ny42MjctLjI4LjkwNiAwIC4wMzUgMCAuMDcuMDE3LjEyMi4zMTQuOTI0LjQgMS44NjUuNDUzIDIuODI0di4zNWMwIC40MTgtLjAxNy4zMy4zMy40Ny4xNC4wNTIuMjk2LjA3LjQzNi4xNzQuMTA1IDAgLjEyMi0uMDg3LjEyMi0uMTU3bC0uMDUyLS41NzV2LTEuNjA0Yy0uMDE3LS4yOC4wMzUtLjU1OC4wNy0uODJ6IiBmaWxsPSIjYzJiZmJmIi8+Cjwvc3ZnPgo="
    catalog.cluster.local/maintainer: ""
    catalog.cluster.local/url: "https://www.mongodb.com"
    catalog.cluster.local/tags: "database,unmanaged,helm"
spec:
  compositeTypeRef:
    apiVersion: catalog.cluster.local/v1
    kind: MongoDBComposite

  writeConnectionSecretsToNamespace: crossplane-system

  mode: Pipeline
  pipeline:
    - step: patch-and-transform
      functionRef:
        name: crossplane-contrib-function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        environment: null
        kind: Resources
        patchSets: []
        resources:
          - name: helm-release
            base:
              apiVersion: helm.crossplane.io/v1beta1
              kind: Release
              metadata:
                annotations:
                  crossplane.io/external-name: tbd
              spec:
                providerConfigRef:
                  name: provider-helm
                forProvider:
                  chart:
                    name: mongodb
                    repository: oci://registry-1.docker.io/bitnamicharts
                    version: 15.1.4 # also update the version in the map transform below!
                  namespace: tbd
                  values:
                    commonLabels:
                      catalog.cluster.local/kind: tbd
                      catalog.cluster.local/name: tbd

                    fullnameOverride: tbd
                    architecture: standalone

                    auth:
                      rootUser: root

                    persistence:
                      size: 8Gi

                    persistentVolumeClaimRetentionPolicy:
                      enabled: true
                      whenDeleted: Delete

                    # metrics:
                    #   enabled: true
                    #   serviceMonitor:
                    #     enabled: true

                connectionDetails:
                  - apiVersion: v1
                    kind: Secret
                    name:
                    namespace:
                    fieldPath: data.mongodb-root-password
                    toConnectionSecretKey: password

                  - apiVersion: v1
                    kind: Service
                    name:
                    namespace:
                    fieldPath: spec.ports[0].port
                    toConnectionSecretKey: port

                writeConnectionSecretToRef:
                  namespace: tbd

            connectionDetails:
              - name: username
                type: FromValue
                value: root

              - name: password
                type: FromConnectionSecretKey
                fromConnectionSecretKey: password

              - name: port
                type: FromConnectionSecretKey
                fromConnectionSecretKey: port

              - name: host
                type: FromFieldPath
                fromFieldPath: "metadata.annotations['host']"

            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.size"
                toFieldPath: "spec.forProvider.values.persistence.size"

              - type: FromCompositeFieldPath
                fromFieldPath: "spec.claimRef.name"
                toFieldPath: "spec.forProvider.values.fullnameOverride"

              - type: FromCompositeFieldPath
                fromFieldPath: "spec.claimRef.name"
                toFieldPath: "spec.forProvider.values.commonLabels['catalog.cluster.local/name']"

              - type: FromCompositeFieldPath
                fromFieldPath: "spec.claimRef.kind"
                toFieldPath: "spec.forProvider.values.commonLabels['catalog.cluster.local/kind']"


              - type: FromCompositeFieldPath
                fromFieldPath: "spec.version"
                toFieldPath: "spec.forProvider.chart.version"
                transforms:
                  - type: map
                    map:
                      "7": "15.1.4"
                      "6": "13.16.2"
                      
              - type: ToCompositeFieldPath
                fromFieldPath: "spec.forProvider.chart.version"
                toFieldPath: "spec.version"
                transforms:
                  - type: map
                    map:
                      "15.1.4": "7"
                      "13.16.2": "6"

              - type: FromCompositeFieldPath
                fromFieldPath: "spec.claimRef.name"
                toFieldPath: "metadata.annotations[crossplane.io/external-name]"

              - type: FromCompositeFieldPath
                fromFieldPath: "spec.claimRef.namespace"
                toFieldPath: "spec.forProvider.namespace"

              - type: FromCompositeFieldPath
                fromFieldPath: "spec.claimRef.name"
                toFieldPath: "spec.connectionDetails[0].name"

              - type: FromCompositeFieldPath
                fromFieldPath: "spec.claimRef.namespace"
                toFieldPath: "spec.connectionDetails[0].namespace"

              - type: FromCompositeFieldPath
                fromFieldPath: "spec.claimRef.name"
                toFieldPath: "spec.connectionDetails[1].name"

              - type: FromCompositeFieldPath
                fromFieldPath: "spec.claimRef.namespace"
                toFieldPath: "spec.connectionDetails[1].namespace"

              - type: FromCompositeFieldPath
                fromFieldPath: "spec.claimRef.namespace"
                toFieldPath: "spec.writeConnectionSecretToRef.namespace"

              - type: FromCompositeFieldPath
                fromFieldPath: "spec.resourceRefs[0].name"
                toFieldPath: "spec.writeConnectionSecretToRef.name"
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-connection"

              - type: CombineToComposite
                combine:
                  variables:
                    - fromFieldPath: spec.forProvider.values.fullnameOverride
                    - fromFieldPath: spec.forProvider.namespace
                  strategy: string
                  string:
                    fmt: "%s.%s"
                toFieldPath: status.credentials.host

              - type: FromCompositeFieldPath
                fromFieldPath: "status.credentials.host"
                toFieldPath: "metadata.annotations['host']"
